<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Dashboard - SmartLink Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f7;
            padding: 32px;
            color: #1d1d1f;
        }

        .dashboard {
            max-width: 1280px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .header-left h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-left p {
            font-size: 14px;
            color: #86868b;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .back-btn {
            background: white;
            color: #1d1d1f;
            border: 1px solid #d2d2d7;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            border-color: #ff3b30;
            transform: translateY(-1px);
        }

        .export-btn {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #e6342a;
            transform: translateY(-1px);
        }

        .time-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
        }

        .time-btn {
            background: white;
            border: 1px solid #d2d2d7;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }

        .time-btn.active {
            background: #ff3b30;
            color: white;
            border-color: #ff3b30;
        }

        .time-btn:hover:not(.active) {
            border-color: #ff3b30;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            background: #ff3b30;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .kpi-icon svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .kpi-label {
            font-size: 13px;
            color: #86868b;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .kpi-change {
            font-size: 12px;
            color: #ff3b30;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #ff3b30;
            margin-bottom: 20px;
        }

        .platforms-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .platform-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            text-align: center;
        }

        .platform-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            overflow: hidden;
        }

        .platform-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .spotify { background: #1DB954; }
        .apple { background: #FA2D48; }
        .youtube { background: #FF0000; }
        .deezer { background: #FF6600; }
        .soundcloud { background: #FF8800; }

        .platform-badge {
            background: #FFD700;
            color: #1d1d1f;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 8px;
        }

        .platform-name {
            font-size: 13px;
            color: #86868b;
            margin-bottom: 8px;
        }

        .platform-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .platform-change {
            font-size: 11px;
            color: #86868b;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #86868b;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            color: #F44336;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        @media (max-width: 1024px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .platforms-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 16px;
            }
            .kpi-grid,
            .platforms-grid {
                grid-template-columns: 1fr;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1 id="smartlink-title">SmartLink Analytics</h1>
                <p id="smartlink-subtitle">Performance Dashboard</p>
            </div>
            <div class="header-actions">
                <a href="/pages/list-smartlinks.html" class="back-btn">
                    ‚Üê Retour √† la liste
                </a>
                <button class="export-btn" onclick="exportPDF()">üìÑ Export PDF</button>
            </div>
        </div>

        <!-- Time Selector -->
        <div class="time-selector">
            <button class="time-btn active" data-days="7">7 jours</button>
            <button class="time-btn" data-days="30">30 jours</button>
            <button class="time-btn" data-days="90">90 jours</button>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="error-message" style="display: none;">
            <!-- Error will be displayed here -->
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <span>Chargement des analytics...</span>
        </div>

        <!-- Analytics Content -->
        <div id="analytics-content" style="display: none;">
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    </div>
                    <div class="kpi-label">Vues de Page</div>
                    <div class="kpi-value" id="total-pageviews">0</div>
                    <div class="kpi-change" id="pageviews-change">--% vs 7j</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    </div>
                    <div class="kpi-label">Clics Plateformes</div>
                    <div class="kpi-value" id="total-clicks">0</div>
                    <div class="kpi-change" id="clicks-change">--% vs 7j</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon">
                        <svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
                    </div>
                    <div class="kpi-label">Taux de Conversion</div>
                    <div class="kpi-value" id="conversion-rate">0%</div>
                    <div class="kpi-change" id="conversion-change">--% vs 7j</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    </div>
                    <div class="kpi-label">Top Plateforme</div>
                    <div class="kpi-value" id="top-platform">--</div>
                    <div class="kpi-change" id="top-platform-percentage">--%</div>
                </div>
            </div>

            <!-- Top Platforms -->
            <h2 class="section-title">Top Plateformes</h2>
            <div id="platforms-grid" class="platforms-grid">
                <!-- Platform cards will be populated here -->
            </div>

            <!-- Evolution Chart -->
            <h2 class="section-title">√âvolution des clics</h2>
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/config.js"></script>
    <script src="/assets/js/admin.js?v=1.0.2"></script>
    <script>
        // Global variables
        let smartlinkId = null;
        let currentPeriod = 7;
        let evolutionChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkSmartLinkId();
            setupTimeSelector();
        });

        function checkSmartLinkId() {
            const urlParams = new URLSearchParams(window.location.search);
            smartlinkId = urlParams.get('id');

            if (!smartlinkId) {
                showError('ID du SmartLink manquant');
                return;
            }

            loadSmartLinkData();
            loadAnalytics();
        }

        async function loadSmartLinkData() {
            try {
                console.log('üîç Loading SmartLink data for ID:', smartlinkId);
                const response = await mdmcAdmin.apiCall(`/api/smartlinks/${smartlinkId}`);

                if (response.success && response.smartlink) {
                    updateHeader(response.smartlink);
                } else {
                    showError('SmartLink non trouv√©');
                }
            } catch (error) {
                console.error('Error loading SmartLink:', error);
                showError('Erreur lors du chargement du SmartLink');
            }
        }

        function updateHeader(smartlink) {
            document.getElementById('smartlink-title').textContent = smartlink.title || 'SmartLink Analytics';
            document.getElementById('smartlink-subtitle').textContent = smartlink.artist ? `${smartlink.artist} - Performance Dashboard` : 'Performance Dashboard';
        }

        async function loadAnalytics() {
            try {
                console.log('üìä Loading analytics for SmartLink ID:', smartlinkId, 'Period:', currentPeriod);
                const response = await mdmcAdmin.apiCall(`/api/smartlinks/${smartlinkId}/analytics?days=${currentPeriod}`);

                console.log('üì• Analytics response:', response);

                if (response.success) {
                    displayAnalytics(response.analytics);
                } else {
                    showError(response.error || 'Erreur lors du chargement des analytics');
                }
            } catch (error) {
                console.error('‚ùå Error loading analytics:', error);
                showError('Impossible de charger les analytics');
            }
        }

        function displayAnalytics(analytics) {
            console.log('üéØ Displaying analytics:', analytics);

            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('analytics-content').style.display = 'block';

            // Calculate metrics
            const totalPageviews = analytics.total_pageviews || 0;
            const totalClicks = analytics.total_clicks || 0;
            const conversionRate = totalPageviews > 0 ? ((totalClicks / totalPageviews) * 100).toFixed(1) : 0;

            // Update KPI cards
            document.getElementById('total-pageviews').textContent = formatNumber(totalPageviews);
            document.getElementById('total-clicks').textContent = formatNumber(totalClicks);
            document.getElementById('conversion-rate').textContent = conversionRate + '%';
            document.getElementById('top-platform').textContent = analytics.top_platform || '--';

            // Update changes (placeholder for now)
            document.getElementById('pageviews-change').textContent = '-- vs 7j';
            document.getElementById('clicks-change').textContent = '-- vs 7j';
            document.getElementById('conversion-change').textContent = '-- vs 7j';
            document.getElementById('top-platform-percentage').textContent = '--';

            // Update platforms grid
            updatePlatformsGrid(analytics.platform_stats || []);

            // Update evolution chart
            updateEvolutionChart(analytics.daily_clicks || []);
        }

        function updatePlatformsGrid(platformStats) {
            const container = document.getElementById('platforms-grid');

            if (!platformStats.length) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #86868b; padding: 40px;">Aucune donn√©e de plateforme disponible</p>';
                return;
            }

            // Sort platforms by clicks
            const sortedPlatforms = platformStats.sort((a, b) => b.clicks - a.clicks);
            const totalClicks = sortedPlatforms.reduce((sum, p) => sum + p.clicks, 0);

            container.innerHTML = sortedPlatforms.slice(0, 5).map((platform, index) => {
                const percentage = totalClicks > 0 ? ((platform.clicks / totalClicks) * 100).toFixed(1) : 0;
                const platformClass = getPlatformClass(platform.platform);
                const badge = index === 0 ? '<div class="platform-badge">üèÜ #1</div>' : '';

                return `
                    <div class="platform-card">
                        ${badge}
                        <div class="platform-icon ${platformClass}">
                            <img src="${getPlatformIcon(platform.platform)}" alt="${platform.platform}" />
                        </div>
                        <div class="platform-name">${platform.platform || 'Inconnu'}</div>
                        <div class="platform-value">${formatNumber(platform.clicks)}</div>
                        <div class="platform-change">${percentage}% du total</div>
                    </div>
                `;
            }).join('');
        }

        function updateEvolutionChart(dailyClicks) {
            const ctx = document.getElementById('evolutionChart').getContext('2d');

            // Destroy existing chart
            if (evolutionChart) {
                evolutionChart.destroy();
            }

            if (!dailyClicks.length) {
                ctx.fillStyle = '#86868b';
                ctx.textAlign = 'center';
                ctx.fillText('Aucune donn√©e disponible', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const labels = dailyClicks.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('fr-FR', { month: 'short', day: 'numeric' });
            });

            const totalData = dailyClicks.map(item => parseInt(item.clicks));

            // Group platform data
            const platformDatasets = {};
            dailyClicks.forEach(day => {
                if (day.platform_breakdown) {
                    day.platform_breakdown.forEach(platform => {
                        if (!platformDatasets[platform.platform]) {
                            platformDatasets[platform.platform] = {
                                label: platform.platform,
                                data: new Array(labels.length).fill(0),
                                borderColor: getPlatformColor(platform.platform),
                                backgroundColor: getPlatformColor(platform.platform, 0.1),
                                tension: 0.4,
                                fill: false
                            };
                        }
                        const dayIndex = labels.indexOf(day.date);
                        if (dayIndex !== -1) {
                            platformDatasets[platform.platform].data[dayIndex] = platform.clicks;
                        }
                    });
                }
            });

            const datasets = [
                {
                    label: 'Total',
                    data: totalData,
                    borderColor: '#1d1d1f',
                    backgroundColor: 'rgba(29, 29, 31, 0.1)',
                    tension: 0.4,
                    fill: false,
                    borderWidth: 3
                },
                ...Object.values(platformDatasets)
            ];

            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function setupTimeSelector() {
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update active state
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Update period and reload
                    currentPeriod = parseInt(this.dataset.days);

                    // Show loading
                    document.getElementById('analytics-content').style.display = 'none';
                    document.getElementById('loading').style.display = 'flex';

                    loadAnalytics();
                });
            });
        }

        // Helper functions
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function getPlatformClass(platform) {
            const platformName = (platform || '').toLowerCase();
            if (platformName.includes('spotify')) return 'spotify';
            if (platformName.includes('apple')) return 'apple';
            if (platformName.includes('youtube')) return 'youtube';
            if (platformName.includes('deezer')) return 'deezer';
            if (platformName.includes('soundcloud')) return 'soundcloud';
            return 'spotify';
        }

        function getPlatformIcon(platform) {
            const platformName = (platform || '').toLowerCase();
            if (platformName.includes('spotify')) return '/assets/images/platforms/picto_spotify.png';
            if (platformName.includes('apple')) return '/assets/images/platforms/picto_apple.png';
            if (platformName.includes('youtube')) return '/assets/images/platforms/picto_youtube.png';
            if (platformName.includes('deezer')) return '/assets/images/platforms/picto_deezer.png';
            if (platformName.includes('soundcloud')) return '/assets/images/platforms/picto_soundcloud.png';
            if (platformName.includes('tidal')) return '/assets/images/platforms/picto_tidal.png';
            if (platformName.includes('amazon')) return '/assets/images/platforms/picto_amazon.png';
            if (platformName.includes('youtubemusic')) return '/assets/images/platforms/picto_youtubemusic.png';
            return '/assets/images/platforms/picto_spotify.png'; // Default fallback
        }

        function getPlatformColor(platform, alpha = 1) {
            const platformName = (platform || '').toLowerCase();
            if (platformName.includes('spotify')) return alpha === 1 ? '#1DB954' : `rgba(29, 185, 84, ${alpha})`;
            if (platformName.includes('apple')) return alpha === 1 ? '#FA2D48' : `rgba(250, 45, 72, ${alpha})`;
            if (platformName.includes('youtube')) return alpha === 1 ? '#FF0000' : `rgba(255, 0, 0, ${alpha})`;
            if (platformName.includes('deezer')) return alpha === 1 ? '#FF6600' : `rgba(255, 102, 0, ${alpha})`;
            if (platformName.includes('soundcloud')) return alpha === 1 ? '#FF8800' : `rgba(255, 136, 0, ${alpha})`;
            return alpha === 1 ? '#1DB954' : `rgba(29, 185, 84, ${alpha})`;
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.display = 'block';
        }

        // Export PDF function
        function exportPDF() {
            alert('Fonctionnalit√© d\'export PDF - √Ä connecter avec votre backend');
        }
    </script>
</body>
</html>