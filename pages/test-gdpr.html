<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test RGPD - MDMC SmartLinks</title>

  <!-- GDPR Consent Manager -->
  <script src="/src/lib/consent-manager.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .test-section {
      margin: 30px 0;
      padding: 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
    }
    .consent-status {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <!-- Simulated tracking pixels configuration -->
  <script>
    window.TRACKING_PIXELS = {
      google_analytics: 'G-098G18MJ7M',
      google_tag_manager: 'GTM-572GXWPP',
      meta_pixel: null,
      tiktok_pixel: null,
      custom_scripts: []
    };
  </script>

  <div class="container">
    <h1>ğŸ§ª Test SystÃ¨me RGPD - MDMC SmartLinks</h1>
    <p>Cette page teste le systÃ¨me de gestion du consentement RGPD.</p>

    <div class="test-section">
      <h2>ğŸ“Š Ã‰tat actuel du consentement</h2>
      <div id="consent-status" class="consent-status">
        Chargement...
      </div>
      <button onclick="refreshConsentStatus()">ğŸ”„ Actualiser</button>
    </div>

    <div class="test-section">
      <h2>ğŸª Actions de test</h2>
      <button onclick="showConsentBanner()">ğŸª Afficher banniÃ¨re de consentement</button>
      <button onclick="showConsentModal()">âš™ï¸ Ouvrir modal de personnalisation</button>
      <button onclick="clearConsent()">ğŸ—‘ï¸ Effacer le consentement</button>
      <button onclick="testConsentAPI()">ğŸ”— Tester API de consentement</button>
    </div>

    <div class="test-section">
      <h2>ğŸ¯ Test des pixels de tracking</h2>
      <div id="tracking-status" class="status info">
        â³ VÃ©rification des pixels en cours...
      </div>
      <button onclick="checkTrackingPixels()">ğŸ” VÃ©rifier les pixels</button>
      <button onclick="testTrackingEvents()">ğŸ“¡ Tester les Ã©vÃ©nements</button>
    </div>

    <div class="test-section">
      <h2>ğŸ“‹ Journal des Ã©vÃ©nements</h2>
      <div id="event-log" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px;">
        [Initialisation du journal...]<br>
      </div>
      <button onclick="clearLog()">ğŸ§¹ Vider le journal</button>
    </div>

    <div class="test-section">
      <h2>âš–ï¸ ConformitÃ© RGPD</h2>
      <div id="gdpr-compliance" class="status info">
        â³ VÃ©rification de la conformitÃ©...
      </div>
      <ul id="compliance-checklist">
        <li>BanniÃ¨re de consentement prÃ©sente</li>
        <li>Consentement granulaire (analytique/marketing)</li>
        <li>PossibilitÃ© de retirer le consentement</li>
        <li>Politique de confidentialitÃ© accessible</li>
        <li>Audit trail des consentements</li>
        <li>Expiration du consentement (12 mois)</li>
      </ul>
    </div>

    <div class="test-section">
      <h2>ğŸ”— Liens utiles</h2>
      <a href="/privacy-policy" target="_blank" style="color: #007bff; text-decoration: none; margin-right: 20px;">
        ğŸ“„ Politique de confidentialitÃ©
      </a>
      <a href="/api/consent/audit" target="_blank" style="color: #007bff; text-decoration: none;">
        ğŸ“Š Audit des consentements (Admin)
      </a>
    </div>
  </div>

  <script>
    let eventLog = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      eventLog.push(logEntry);

      const logElement = document.getElementById('event-log');
      logElement.innerHTML += logEntry + '<br>';
      logElement.scrollTop = logElement.scrollHeight;
    }

    function clearLog() {
      eventLog = [];
      document.getElementById('event-log').innerHTML = '[Journal vidÃ©]<br>';
    }

    function refreshConsentStatus() {
      if (!window.consentManager) {
        document.getElementById('consent-status').textContent = 'Gestionnaire de consentement non chargÃ©';
        return;
      }

      const status = {
        hasValidConsent: window.consentManager.hasValidConsent(),
        consentData: window.consentManager.consentData,
        isConsentValid: window.consentManager.isConsentValid()
      };

      document.getElementById('consent-status').textContent = JSON.stringify(status, null, 2);
      log('Ã‰tat du consentement actualisÃ©');
    }

    function showConsentBanner() {
      if (window.consentManager) {
        // Force l'affichage en supprimant temporairement le timestamp
        const originalTimestamp = window.consentManager.consentData.timestamp;
        window.consentManager.consentData.timestamp = null;
        window.consentManager.showConsentBanner();
        window.consentManager.consentData.timestamp = originalTimestamp;
        log('BanniÃ¨re de consentement affichÃ©e (forcÃ©e)');
      } else {
        log('Gestionnaire de consentement non disponible', 'error');
      }
    }

    function showConsentModal() {
      if (window.consentManager) {
        window.consentManager.showConsentModal();
        log('Modal de personnalisation affichÃ©e');
      } else {
        log('Gestionnaire de consentement non disponible', 'error');
      }
    }

    function clearConsent() {
      localStorage.removeItem('mdmc_consent');
      log('Consentement effacÃ© du localStorage');
      refreshConsentStatus();
    }

    async function testConsentAPI() {
      try {
        // Test de sauvegarde de consentement
        const testConsent = {
          functional: true,
          analytics: true,
          marketing: false,
          timestamp: new Date().toISOString(),
          version: '1.0',
          userAgent: navigator.userAgent,
          ipAddress: 'test'
        };

        const response = await fetch('/api/consent/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(testConsent)
        });

        const result = await response.json();
        log(`API de consentement testÃ©e: ${JSON.stringify(result)}`);

        // Test de rÃ©cupÃ©ration d'IP
        const ipResponse = await fetch('/api/client-ip');
        const ipResult = await ipResponse.json();
        log(`IP du client: ${ipResult.ip}`);

      } catch (error) {
        log(`Erreur lors du test API: ${error.message}`, 'error');
      }
    }

    function checkTrackingPixels() {
      let pixelsDetected = 0;
      let totalPixels = 0;

      // VÃ©rifier Google Analytics
      if (window.TRACKING_PIXELS.google_analytics) {
        totalPixels++;
        if (typeof gtag !== 'undefined' && window.dataLayer) {
          pixelsDetected++;
          log('âœ… Google Analytics dÃ©tectÃ©');
        } else {
          log('âŒ Google Analytics non dÃ©tectÃ©');
        }
      }

      // VÃ©rifier Google Tag Manager
      if (window.TRACKING_PIXELS.google_tag_manager) {
        totalPixels++;
        if (window.dataLayer && window.dataLayer.length > 0) {
          pixelsDetected++;
          log('âœ… Google Tag Manager dÃ©tectÃ©');
        } else {
          log('âŒ Google Tag Manager non dÃ©tectÃ©');
        }
      }

      // VÃ©rifier Meta Pixel
      if (window.TRACKING_PIXELS.meta_pixel) {
        totalPixels++;
        if (typeof fbq !== 'undefined') {
          pixelsDetected++;
          log('âœ… Meta Pixel dÃ©tectÃ©');
        } else {
          log('âŒ Meta Pixel non dÃ©tectÃ©');
        }
      }

      // VÃ©rifier TikTok Pixel
      if (window.TRACKING_PIXELS.tiktok_pixel) {
        totalPixels++;
        if (typeof ttq !== 'undefined') {
          pixelsDetected++;
          log('âœ… TikTok Pixel dÃ©tectÃ©');
        } else {
          log('âŒ TikTok Pixel non dÃ©tectÃ©');
        }
      }

      const statusElement = document.getElementById('tracking-status');
      if (pixelsDetected === totalPixels) {
        statusElement.innerHTML = `âœ… Tous les pixels dÃ©tectÃ©s (${pixelsDetected}/${totalPixels})`;
        statusElement.className = 'status success';
      } else {
        statusElement.innerHTML = `âš ï¸ Pixels partiellement dÃ©tectÃ©s (${pixelsDetected}/${totalPixels})`;
        statusElement.className = 'status error';
      }

      log(`VÃ©rification pixels: ${pixelsDetected}/${totalPixels} dÃ©tectÃ©s`);
    }

    function testTrackingEvents() {
      // Test d'Ã©vÃ©nements Google Analytics
      if (typeof gtag !== 'undefined') {
        gtag('event', 'gdpr_test', {
          event_category: 'test',
          event_label: 'gdpr_system_test'
        });
        log('Ã‰vÃ©nement Google Analytics envoyÃ©');
      }

      // Test d'Ã©vÃ©nements Meta Pixel
      if (typeof fbq !== 'undefined') {
        fbq('track', 'ViewContent', {
          content_name: 'GDPR Test',
          content_category: 'Test'
        });
        log('Ã‰vÃ©nement Meta Pixel envoyÃ©');
      }

      // Test d'Ã©vÃ©nements TikTok Pixel
      if (typeof ttq !== 'undefined') {
        ttq.track('ViewContent', {
          content_name: 'GDPR Test'
        });
        log('Ã‰vÃ©nement TikTok Pixel envoyÃ©');
      }

      log('Tests d\'Ã©vÃ©nements terminÃ©s');
    }

    // Ã‰couteur d'Ã©vÃ©nements de consentement
    window.addEventListener('consentChanged', function(event) {
      log(`Consentement modifiÃ©: ${JSON.stringify(event.detail)}`);
      refreshConsentStatus();
      checkTrackingPixels();
    });

    // Initialisation automatique
    window.addEventListener('load', function() {
      log('Page de test RGPD chargÃ©e');

      setTimeout(() => {
        refreshConsentStatus();
        checkTrackingPixels();
        log('Tests automatiques terminÃ©s');
      }, 2000);
    });

    // VÃ©rification pÃ©riodique de la conformitÃ©
    setInterval(() => {
      const complianceElement = document.getElementById('gdpr-compliance');

      if (window.consentManager) {
        complianceElement.innerHTML = 'âœ… SystÃ¨me RGPD opÃ©rationnel';
        complianceElement.className = 'status success';
      } else {
        complianceElement.innerHTML = 'âŒ Gestionnaire de consentement non chargÃ©';
        complianceElement.className = 'status error';
      }
    }, 5000);
  </script>
</body>
</html>