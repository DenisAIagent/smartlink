<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test RGPD - MDMC SmartLinks</title>

  <!-- GDPR Consent Manager -->
  <script src="/src/lib/consent-manager.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .test-section {
      margin: 30px 0;
      padding: 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
    }
    .consent-status {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <!-- Simulated tracking pixels configuration -->
  <script>
    window.TRACKING_PIXELS = {
      google_analytics: 'G-098G18MJ7M',
      google_tag_manager: 'GTM-572GXWPP',
      meta_pixel: null,
      tiktok_pixel: null,
      custom_scripts: []
    };
  </script>

  <div class="container">
    <h1>üß™ Test Syst√®me RGPD - MDMC SmartLinks</h1>
    <p>Cette page teste le syst√®me de gestion du consentement RGPD.</p>

    <div class="test-section">
      <h2>üìä √âtat actuel du consentement</h2>
      <div id="consent-status" class="consent-status">
        Chargement...
      </div>
      <button onclick="refreshConsentStatus()">üîÑ Actualiser</button>
    </div>

    <div class="test-section">
      <h2>üç™ Actions de test</h2>
      <button onclick="showConsentBanner()">üç™ Afficher banni√®re de consentement</button>
      <button onclick="showConsentModal()">‚öôÔ∏è Ouvrir modal de personnalisation</button>
      <button onclick="clearConsent()">üóëÔ∏è Effacer le consentement</button>
      <button onclick="testConsentAPI()">üîó Tester API de consentement</button>
    </div>

    <div class="test-section">
      <h2>üéØ Test des pixels de tracking</h2>
      <div id="tracking-status" class="status info">
        ‚è≥ V√©rification des pixels en cours...
      </div>
      <button onclick="checkTrackingPixels()">üîç V√©rifier les pixels</button>
      <button onclick="testTrackingEvents()">üì° Tester les √©v√©nements</button>
    </div>

    <div class="test-section">
      <h2>üìã Journal des √©v√©nements</h2>
      <div id="event-log" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px;">
        [Initialisation du journal...]<br>
      </div>
      <button onclick="clearLog()">üßπ Vider le journal</button>
    </div>

    <div class="test-section">
      <h2>‚öñÔ∏è Conformit√© RGPD</h2>
      <div id="gdpr-compliance" class="status info">
        ‚è≥ V√©rification de la conformit√©...
      </div>
      <ul id="compliance-checklist">
        <li>Banni√®re de consentement pr√©sente</li>
        <li>Consentement granulaire (analytique/marketing)</li>
        <li>Possibilit√© de retirer le consentement</li>
        <li>Politique de confidentialit√© accessible</li>
        <li>Audit trail des consentements</li>
        <li>Expiration du consentement (12 mois)</li>
      </ul>
    </div>

    <div class="test-section">
      <h2>üîó Liens utiles</h2>
      <a href="/privacy-policy" target="_blank" style="color: #007bff; text-decoration: none; margin-right: 20px;">
        üìÑ Politique de confidentialit√©
      </a>
      <a href="/api/consent/audit" target="_blank" style="color: #007bff; text-decoration: none;">
        üìä Audit des consentements (Admin)
      </a>
    </div>
  </div>

  <script>
    let eventLog = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      eventLog.push(logEntry);

      const logElement = document.getElementById('event-log');
      logElement.innerHTML += logEntry + '<br>';
      logElement.scrollTop = logElement.scrollHeight;
    }

    function clearLog() {
      eventLog = [];
      document.getElementById('event-log').innerHTML = '[Journal vid√©]<br>';
    }

    function refreshConsentStatus() {
      if (!window.consentManager) {
        document.getElementById('consent-status').textContent = 'Gestionnaire de consentement non charg√©';
        return;
      }

      const status = {
        hasValidConsent: window.consentManager.hasValidConsent(),
        consentData: window.consentManager.consentData,
        isConsentValid: window.consentManager.isConsentValid()
      };

      document.getElementById('consent-status').textContent = JSON.stringify(status, null, 2);
      log('√âtat du consentement actualis√©');
    }

    function showConsentBanner() {
      if (window.consentManager) {
        // Force l'affichage en supprimant temporairement le timestamp
        const originalTimestamp = window.consentManager.consentData.timestamp;
        window.consentManager.consentData.timestamp = null;
        window.consentManager.showConsentBanner();
        window.consentManager.consentData.timestamp = originalTimestamp;
        log('Banni√®re de consentement affich√©e (forc√©e)');
      } else {
        log('Gestionnaire de consentement non disponible', 'error');
      }
    }

    function showConsentModal() {
      if (window.consentManager) {
        window.consentManager.showConsentModal();
        log('Modal de personnalisation affich√©e');
      } else {
        log('Gestionnaire de consentement non disponible', 'error');
      }
    }

    function clearConsent() {
      localStorage.removeItem('mdmc_consent');
      log('Consentement effac√© du localStorage');
      refreshConsentStatus();
    }

    async function testConsentAPI() {
      try {
        // Test de sauvegarde de consentement
        const testConsent = {
          functional: true,
          analytics: true,
          marketing: false,
          timestamp: new Date().toISOString(),
          version: '1.0',
          userAgent: navigator.userAgent,
          ipAddress: 'test'
        };

        const response = await fetch('/api/consent/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(testConsent)
        });

        const result = await response.json();
        log(`API de consentement test√©e: ${JSON.stringify(result)}`);

        // Test de r√©cup√©ration d'IP
        const ipResponse = await fetch('/api/client-ip');
        const ipResult = await ipResponse.json();
        log(`IP du client: ${ipResult.ip}`);

      } catch (error) {
        log(`Erreur lors du test API: ${error.message}`, 'error');
      }
    }

    function checkTrackingPixels() {
      let pixelsDetected = 0;
      let totalPixels = 0;

      // V√©rifier Google Analytics
      if (window.TRACKING_PIXELS.google_analytics) {
        totalPixels++;
        if (typeof gtag !== 'undefined' && window.dataLayer) {
          pixelsDetected++;
          log('‚úÖ Google Analytics d√©tect√©');
        } else {
          log('‚ùå Google Analytics non d√©tect√©');
        }
      }

      // V√©rifier Google Tag Manager
      if (window.TRACKING_PIXELS.google_tag_manager) {
        totalPixels++;
        if (window.dataLayer && window.dataLayer.length > 0) {
          pixelsDetected++;
          log('‚úÖ Google Tag Manager d√©tect√©');
        } else {
          log('‚ùå Google Tag Manager non d√©tect√©');
        }
      }

      // V√©rifier Meta Pixel
      if (window.TRACKING_PIXELS.meta_pixel) {
        totalPixels++;
        if (typeof fbq !== 'undefined') {
          pixelsDetected++;
          log('‚úÖ Meta Pixel d√©tect√©');
        } else {
          log('‚ùå Meta Pixel non d√©tect√©');
        }
      }

      // V√©rifier TikTok Pixel
      if (window.TRACKING_PIXELS.tiktok_pixel) {
        totalPixels++;
        if (typeof ttq !== 'undefined') {
          pixelsDetected++;
          log('‚úÖ TikTok Pixel d√©tect√©');
        } else {
          log('‚ùå TikTok Pixel non d√©tect√©');
        }
      }

      const statusElement = document.getElementById('tracking-status');
      if (pixelsDetected === totalPixels) {
        statusElement.innerHTML = `‚úÖ Tous les pixels d√©tect√©s (${pixelsDetected}/${totalPixels})`;
        statusElement.className = 'status success';
      } else {
        statusElement.innerHTML = `‚ö†Ô∏è Pixels partiellement d√©tect√©s (${pixelsDetected}/${totalPixels})`;
        statusElement.className = 'status error';
      }

      log(`V√©rification pixels: ${pixelsDetected}/${totalPixels} d√©tect√©s`);
    }

    function testTrackingEvents() {
      // Test d'√©v√©nements Google Analytics
      if (typeof gtag !== 'undefined') {
        gtag('event', 'gdpr_test', {
          event_category: 'test',
          event_label: 'gdpr_system_test'
        });
        log('√âv√©nement Google Analytics envoy√©');
      }

      // Test d'√©v√©nements Meta Pixel
      if (typeof fbq !== 'undefined') {
        fbq('track', 'ViewContent', {
          content_name: 'GDPR Test',
          content_category: 'Test'
        });
        log('√âv√©nement Meta Pixel envoy√©');
      }

      // Test d'√©v√©nements TikTok Pixel
      if (typeof ttq !== 'undefined') {
        ttq.track('ViewContent', {
          content_name: 'GDPR Test'
        });
        log('√âv√©nement TikTok Pixel envoy√©');
      }

      log('Tests d\'√©v√©nements termin√©s');
    }

    // √âcouteur d'√©v√©nements de consentement
    window.addEventListener('consentChanged', function(event) {
      log(`Consentement modifi√©: ${JSON.stringify(event.detail)}`);
      refreshConsentStatus();
      checkTrackingPixels();
    });

    // Initialisation automatique
    window.addEventListener('load', function() {
      log('Page de test RGPD charg√©e');

      setTimeout(() => {
        refreshConsentStatus();
        checkTrackingPixels();
        log('Tests automatiques termin√©s');
      }, 2000);
    });

    // V√©rification p√©riodique de la conformit√©
    setInterval(() => {
      const complianceElement = document.getElementById('gdpr-compliance');

      if (window.consentManager) {
        complianceElement.innerHTML = '‚úÖ Syst√®me RGPD op√©rationnel';
        complianceElement.className = 'status success';
      } else {
        complianceElement.innerHTML = '‚ùå Gestionnaire de consentement non charg√©';
        complianceElement.className = 'status error';
      }
    }, 5000);
  </script>
</body>
</html>